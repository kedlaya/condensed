<section xml:id="sec_analytic_stacks2">
  <title>Analytic stacks</title>
  <introduction>
    <p>
      In this section, we define analytic stacks and give some examples.
    </p>
    <paragraphs>
      <title>Reference</title>
      <p>
        This section is based on <xref ref="bib-Clausen-Scholze-youtube"/>, Lecture 19.
        <xref ref="rem-morse"/> is taken from  <xref ref="bib-Clausen-Scholze-youtube"/>, Lecture 24.
      </p>
    </paragraphs>
  </introduction>
  <subsection>
    <title>Definition of analytic stacks</title>
    <definition>
      <p>
        An <term>analytic stack</term> is an accessible (<xref ref="rem-accessible"/>)
        functor <m>F\colon \AnRing \to \Set</m> with the following property:
        for any hypercovering <m>\AnSpec(A_\bullet) \to \AnSpec(A)</m> by <m>!</m>-able maps
        for which <m>\calD(\Mod_A) \cong \lim^! \calD(\Mod_{A_\bullet})</m>,
        we have
        <me>
          F(A) \cong \lim X(A_\bullet)
        </me>.
        Let <m>\AnStack</m> be the category of analytic stacks.
      </p>
      <p>
        For example, any representable functor is an analytic stack
        (and by Yoneda this defines a full embedding <m>\AnRing^{\op} \to \AnStack</m>).
        With this, the accessibility condition ensures that
        any object is a small colimit of representable functors.
      </p>
    </definition>
    <remark>
      <p>
        This is not quite the definition of <xref ref="bib-Clausen-Scholze-youtube"/> because
        we are taking functors valued in sets, not something more simplicial.
        This difference is certainly relevant but will not appear in the examples we consider.
      </p>
    </remark>
    <example>
      <p>
        Adic spaces, solid adic spaces, and dagger spaces all give rise to analytic stacks;
        in particular, the last of these include complex analytic spaces and Berkovich spaces.
        However, it is not clear that these functors are fully faithful.
      </p>
    </example>
    <example>
      <p>
        There is a functor <m>\Sch \to \AnStack</m> taking <m>\Spec A</m> to <m>\AnSpec \underline{A}</m>
        where the discrete condensed ring <m>\underline{A}</m> is interpreted as a discrete analytic ring.
        This functor is fully faithful by a theorem of Bhatt.
      </p>
      <p>
        This construction extends further to algebraic stacks.
        For example, using Stone duality (<xref ref="exa-embed-cset-into-schemes"/>) we get a fully faithful functor
        <m>\CSet \to \AnStack</m>.
        This allows to give meaning to the assertion that the definition of a norm function on an analytic ring
        (<xref ref="def-norm-function"/>) corresponds to a morphism <m>\AnSpec A \to [0,\infty]</m> of analytic stacks;
        in this formulation, one can extend the definition immediately to arbitrary analytic stacks.
      </p>
      <p>
        In addition, if we start with an analytic ring <m>A</m>, we can consider schemes over <m>\Spec A^{\triangleright}</m>
        and form the functor taking <m>\Spec B</m> to <m>\AnSpec \underline{B}</m> where <m>\underline{B}</m>
        is given the analytic ring structure induced from <m>A</m>. This again defines a functor to analytic stacks.
      </p>
    </example>
  </subsection>
  <subsection>
    <title>Flavors of the Riemann sphere</title>
    <p>
      To illustrate the richness of the category of analytic stacks, we indicate how some different flavors of the
      Riemann sphere interact within this category.
    </p>
    <example>
      <p>
        We can form a sequence of morphisms of analytic stacks
        <me>
          X_1 \to X_2 \to X_3 \to X_4 \to X_5 \to X_6 
        </me>
        in which:
        <ul>
          <li>
            <m>X_1</m> is the topological manifold <m>S^2</m>.
            This corresponds to taking the ring <m>\Cts(S^2, \CC)</m> over <m>\CC_{\liquid}</m>.
          </li>
          <li>
            <m>X_2</m> is the <m>C^\infty</m> manifold <m>S^2</m>.
            This again corresponds to take the ring of global sections.
          </li>
          <li>
            <m>X_3</m> is the real analytic manifold <m>S^2</m>. This cannot be treated globally;
            instead it is created by glueing as in <xref ref="sec_gaga2"/>.
          </li>
          <li>
            <m>X_4</m> is the complex analytic manifold <m>S^2</m>. This is again created by glueing.
          </li>
          <li>
            <m>X_5</m> is the scheme <m>\PP^1_\CC</m>. This is again created by glueing.
          </li>
          <li>
            <m>X_6</m> is the topological space <m>S^2</m> treated as a condensed set.
            As a reminder, this is created by covering <m>S^2</m> with a profinite set.
          </li>
        </ul>
        <xref ref="thm-gaga-liquid"/> implies that <m>X_4 \to X_5</m> is an isomorphism of analytic stacks!
        The other maps are not isomorphisms.
      </p>
    </example>
  </subsection>
  <subsection>
    <title>A final remark</title>
    <remark xml:id="rem-morse">
      <p>
        One potential use of this setup is to construct the sort of <term>virtual fundamental classes</term>
        which are needed all over the place in enumerative geometry. These are needed to count intersections
        of two geometric objects in cases where the <q>expected dimension</q> of the intersection is 0
        but things can sometimes behave more badly. This is fairly familiar in algebraic geometry, where
        various techniques exist to handle this (moving lemmas, deformation to the normal cone) but is
        much more problematic in less rigid geometries, such as symplectic geometry (where such enumerative
        questions are fundamental in mirror symmetry).
      </p>
      <p>
        A model case of this can be seen by considering <m>R = \Cts(\RR, \RR)</m> as a condensed ring.
        It can be shown that for <m>f \in R</m>, the isomorphism class of the quotient <m>R/(f)</m>
        determines <m>f</m> up to a unit; in particular this can be used to detect whether <m>f</m> has a sign
        crossing at one of its zeroes, even when the Taylor series of <m>f</m> is identically zero.
      </p>
    </remark>
  </subsection>
  <subsection>
    <title>Material to be removed</title>
    <lemma xml:id="lem-sheafy-exact-sequence-v2">
      <statement>
        <p>
          Let <m>A</m> be a solid analytic ring. Then for any <m>f \in A(*)</m>,
          for <m>g \in \{1, 1-f\}</m>, for any <m>M \in \Mod_A</m>, the sequence
          <me>
            0\to M \to M \otimes_A A^{\triangleright} \left\langle \tfrac{f}{g} \right\rangle \oplus 
            M \otimes_A A^{\triangleright} \left\langle \tfrac{g}{f} \right\rangle \to 
            M \otimes_A A^{\triangleright} \left\langle \tfrac{f}{g}, \tfrac{g}{f} \right\rangle \to 0
          </me>
          is exact.
        </p>
      </statement>
      <proof>
        <p>
          Since the map in <xref ref="lem-solid-split-laurent-poly-ring"/> (taking <m>R := A^{\triangleright}</m>) is an isomorphism,
          it remains an isomorphism after tensoring with <m>A</m>.
          Meanwhile, by <xref ref="cor-flat-mult-f-v2"/>, the sequences used in the proof of <xref ref="lem-sheafy-exact-sequence-v1"/>
          remain exact after tensoring with <m>M</m>, so we may emulate the argument therein.
        </p>
      </proof>
    </lemma>
    <definition xml:id="def-loose-rational-localization">
      <p>
        Let <m>A \to B</m> be a rational localization of solid analytic rings corresponding to parameters
        <m>f_1,\dots,f_n,g\in A^{\triangleright}(*)</m> which generate the unit ideal.
        We can then factor this map through <m>A \to B_0</m>
        where
        <me>
          B_0 = (B^{\triangleright}, \Mod_{B^{\triangleright}} \times_{\Mod_{A^{\triangleright}}} \Mod_A)
        </me>;
        we call the map <m>A \to B_0</m> the <term>loose rational localization</term> defined by <m>f_1,\dots,f_n,g</m>.
      </p>
      <p>
        Define the <term>loose adic topology</term> on <m>\AnRing^{\op}</m> as the Grothendieck topology
        generated by coverings by families of loose rational localizations <m>A \to A_{i,0}</m> arising from
        sequences <m>f_1,\dots,f_n \in A^{\triangleright}(*)</m> generating the unit ideal.
      </p>
    </definition>
    <p>
      We start with the following generalization of <xref ref="lem-sheafy-exact-sequence"/>.
    </p>
    <lemma xml:id="lem-general-mod-exact-on-binary-covering">
      <statement>
        <p>
          For <m>A</m> a solid analytic ring, for <m>f,g \in A^{\triangleright}(*)</m> which generate the unit ideal,
          for any <m>A \in \Mod_A</m>, the sequence
          <me>
            0 \to M \to M \otimes_A A^{\triangleright} \left\langle \frac{f}{g} \right\rangle
            \oplus M \otimes_A A^{\triangleright} \left\langle \frac{g}{f} \right\rangle \to
            M \otimes_A A^{\triangleright} \left\langle \frac{f}{g}, \frac{g}{f} \right\rangle \to 0
          </me>
          is exact.
        </p>
      </statement>
      <proof>
        <p>
          In the case where <m>g=1</m> or <m>g=1-f</m> this was already established in <xref ref="lem-sheafy-exact-sequence-v2"/>.
          By this plus <xref ref="prop-standard-binary-coverings-Huber"/>,
          we may check the general case locally with respect to a refinement of the binary covering defined by <m>f,g</m>.
          In particular, we may assume without loss of generality that <m>A = A^{\triangleright} \left\langle \frac{f}{g} \right\rangle</m>,
          in which case also <m>A^{\triangleright} \left\langle \frac{g}{f} \right\rangle = A^{\triangleright} \left\langle \frac{f}{g}, \frac{g}{f} \right\rangle</m>
          and so the sequence in question is split exact.
        </p>
      </proof>
    </lemma>
    <lemma xml:id="lem-mod-to-qcoh-fully-faithful">
      <statement>
        <p>
          For <m>A</m> a solid analytic ring, for <m>f,g \in A^{\triangleright}(*)</m> which generate the unit ideal,
          the map
          <me>
            \Mod_A \to \Mod_{A \left\langle f/g \right\rangle_0} \times_{\Mod_{A \left\langle f/g, g/f \right\rangle_0}} \Mod_{A \left\langle g/f \right\rangle_0}            
          </me>
          is fully faithful.
        </p>
      </statement>
      <proof>
        <p>
          This is immediate from <xref ref="lem-general-mod-exact-on-binary-covering"/>.
        </p>
      </proof>
    </lemma>
    <p>
      Before continuing, it will be helpful to make a corresponding statement for derived categories.
    </p>
    <theorem xml:id="thm-mod-to-qcoh-equivalence">
      <statement>
        <p>
          The categories <m>\Mod_A</m> form a stack for the loose adic topology on <m>\AnRing^{\op}</m>.
        </p>
      </statement>
      <proof>
        <p>
          Usiny <xref ref="prop-standard-binary-coverings-Huber"/>, 
          this reduces to <xref ref="lem-mod-to-qcoh-equivalence"/>.
        </p>
      </proof>
    </theorem>
    <remark xml:id="rem-univ-injective-but-not-flat">
      <p>
        The truth of <xref ref="thm-mod-to-qcoh-equivalence"/> may seem surprising in light of the fact that tensoring with even a loose rational localizations
        is not an exact morphism (<xref ref="exa-localization-not-flat"/>). The point is that loose rational localizations are at least universally
        injective (<xref ref="cor-flat-mult-f-v2"/>) and this is sufficient for descent of modules (compare <xref ref="bib-Stacks"/>, tag 08WE for the case of modules over discrete rings).
        However, the failure of base extension along a loose rational localization 
        to be flat is a compelling argument to introduce derived categories at this point.
      </p>
    </remark>
    <lemma xml:id="lem-mod-to-qcoh-equivalence">
      <statement>
        <p>
          For <m>A</m> a sheafy solid analytic ring, for <m>f,g \in A^{\triangleright}(*)</m> which generate the unit ideal,
          the map
          <me>
            \Mod_A \to \Mod_{A \left\langle f/g \right\rangle_0} \times_{\Mod_{A \left\langle f/g, g/f \right\rangle_0}} \Mod_{A \left\langle g/f \right\rangle_0}            
          </me>
          is an equivalence of categories.
        </p>
      </statement>
      <proof>
        <p>
          By <xref ref="lem-mod-to-qcoh-fully-faithful"/>, the functor is fully faithful.
          To check essential surjectivity, we may apply <xref ref="lem-descent-standard-covering-loose"/> to an element
          of the target category to obtain a complex concentrated in degrees 0 and 1.
          However, we can then apply <xref ref="lem-mod-to-qcoh-fully-faithful"/> again to see that the cohomology in degree 1 vanishes.
        </p>
      </proof>
    </lemma>
    <remark>
      <p>
        The issues raised in <xref ref="rem-univ-injective-but-not-flat"/> and <xref ref="rem-no-sheaf-derived-category"/> become more acute
        when we switch from the loose adic topology back to the adic topology, where
        <xref ref="lem-mod-to-qcoh-equivalence"/> no longer applies: the base extension along a rational localization
        includes an analytic completion step which is not exact. So the best we can hope to assert is that some sort of derived
        category of <m>\Mod_A</m> is a stack for the adic topology, but this is obstructed in the same manner
        as in <xref ref="rem-no-sheaf-derived-category"/>.
      </p>
      <p>
        As a first step, we can at least formulate the analogue of <xref ref="lem-descent-standard-covering-loose"/>.
        A complete resolution will have to wait until we introduce the <m>\infty</m>-categorical analogue of the
        derived category of <m>\Mod_A</m>.
      </p>
    </remark>
    <lemma xml:id="lem-descent-standard-covering">
      <statement>
        <p>
          Let <m>A</m> be a solid analytic ring and choose <m>f,g \in A^{\triangleright}(*)</m> generating the unit ideal.
          Then the base extension functor
          <men xml:id="eq-derived-base-extension-functor">
            D(\Mod_A) \to D(\Mod_{A \left\langle f/g \right\rangle}) \times_{D(\Mod_{A \left\langle f/g, g/f \right\rangle})} D(\Mod_{A \left\langle g/f \right\rangle})
          </men>
          is an equivalence of categories.
        </p>
      </statement>
      <proof>
        <p>
          The proof of <xref ref="lem-descent-standard-covering-loose"/> carries over.
        </p>
      </proof>
    </lemma>
      <p>
        To see that <m>\underline{\ZZ[q]} \to P</m> is flat, we may argue as in <xref ref="lem-flat-mult-f"/>:
        form the exact sequence
        <me>
          0 \to \underline{\ZZ[q]} \otimes P \stackrel{\times (q-[1])}{\to} \underline{\ZZ[q]} \otimes P \to P \to 0
        </me>,
        then observe that for any <m>M \in \Mod_{\underline{\ZZ[q]}}</m>, <m>M \otimes_{\underline{\ZZ[q]}} \underline{\ZZ[q]} \otimes P \cong M \otimes P</m>
        injects into <m>M \otimes (P \oplus \prod_{n \lt 0} \ZZ[n])</m>
        on which multiplication by <m>q-[1] = [1](1 - q[-1])</m> is an isomorphism.
      </p>
  </subsection>
</section>
